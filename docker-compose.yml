version: '3.3'

services:
    db:
        build: ./mysql
        container_name: db
        environment: 
            MYSQL_USER: root
            MYSQL_PASSWORD: docker
            MYSQL_ROOT_PASSWORD: veryveryimportantpassword
            MYSQL_DATABASE: flask_social
        restart: always
        ports:
            - "3306:3306"
        volumes:
            - ./mysql/mysql_data:/var/lib/mysql
            - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf
            - ./mysql/sql:/docker-entrypoint-initdb.d
        command: mysqld
    flask:
        restart: always
        build: .
        container_name: flask
        ports:
            - '5000:5000'
        expose:
            - 5000
        volumes:
            - './src:/src'
        tty: true
        links:
            - db
        environment: 
            TZ: Asia/Tokyo
            FLASK_SECRET_KEY: v3ry_1mp0rt4nt_k3y
            FLASK_APP: app.py
            FLASK_ENV: production
            DB_USER: root
            DB_PASSWORD: veryveryimportantpassword
            DB_HOST: db
            DB_NAME: flask_social
            ENV: PROD
        command: bash -c "flask db init;flask db migrate;flask db upgrade;flask run -h 0.0.0.0"

